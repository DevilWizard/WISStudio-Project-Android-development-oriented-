- [图片加载之三级缓存](#图片加载之三级缓存)
  - [1.内存缓存](#1内存缓存)
### 图片加载之三级缓存

现在，图片浏览几乎是app的必备功能。但由于从网络请求图片再加载到页面这个过程很消耗性能，因此为了优化加载性能，很有必要学习一下图片加载的三级缓存机制，这也是主流图片加载框架的机制。

三级缓存指的是内存缓存、文件缓存和网络缓存，其加载效率依次降低。所以三重缓存机制通过如下方式实现：

首先尝试从内存中读取图片，若有则加载，否则进入读取文件缓存。若从文件缓存中读取成功则加载否则，进入最后的网络读取。

下面就细说一下这三种缓存。

#### 1.内存缓存

那么问题来了，为什么要用内存缓存呢？

**快**。首先内存是读取最快的，并且它不像后两个缓存需要频繁打开I/O流，请求大量资源。为了达到读取快的效果，通常使用HashMap实现，能保证读取的时间复杂度为O(1) ，相当于是即读即用。

**复用性好**。事先分配好一定大小空间的用于内存缓存后，缓存在里面的图片能够根据缓存需要随时更新，比较灵活

**能快速加载浏览最频繁的图片**。这也是非常符合用户逻辑的一个优点。由于内存缓存空间有限，所以缓存内的图片会不断更新，利用这个特性，可以将浏览次数较少的那些图片清除，留下那些浏览次数多的，也就是LRU思想即Least Recently Use，近期最少使用思想，以达到此效果。

#### 2.文件缓存

虽说文件读取的速度仅次于内存缓存，但文件缓存也有它自己的优点。

**存活寿命长**。与在RAM中读取的内存缓存相比，文件缓存是在ROM中读取。最明显的一个优势已经很显然了，内存缓存只能存在于应用运行期间，而文件缓存可以永久保存。

**稳定**。为什么这么说呢？手机的储存容量通常是内存的几十倍不等，比如一台8+256的手机。而且应用运行需要最多的资源的是内存，所以手机系统通常对内存的管理非常严格，会不断的回收一些没用的东西，以清出地方，这就使得内存缓存必须不断的主动释放旧缓存。而文件缓存则是被动释放，只有用户清除应用缓存或卸载应用时它才会被清理。当遇到断网等一些极端情况，就得靠文件缓存救急了。

#### 3.网络缓存

网络这一层其实不算真正意义上的缓存，它的占用资源最多速度最慢，不仅要吃内存还要吃网络，但要拿到图片，必须走这一关。它的主要工作就是把从网络请求图片并将其转为bitmap显示在屏幕上。

说完这三层缓存，现在就来理一下整个三级缓存的工作流程

首先从内存中读取，若有加载，否则往文件缓存中找，若文件缓存中有则加载，否则从网络请求并加载。而实际情况的流程要稍微复杂一些。实际上是先找内存里有没有，没有则从文件缓存或网络上找，若找到则把图片加入内存缓存。而若文件缓存中找不到，则去网络请求，请求完同时将图片缓存至本地文件中。若网络请求不到图片，则显示默认的图片。在这个过程中，只要有一级能拿到图片，就跳过后面的缓存层。也就是从内存缓存拿到了图片，则文件缓存读取和网络请求都不用执行。